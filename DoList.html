<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo List Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./jquery-3.6.0.min.js"></script>
    <style>
        body{
            margin :0px auto;
            text-align: center;
        }
        div{
            margin :0px auto;
            text-align: center;
        }
        #divName{
            margin :0px auto;
            text-align: center;
            height:50px;
        }
        #divClock{
            font-size: 20px;
            color: gray;
            height:40px;
            text-align: end;
        }
        #listToDo,#listDone{
            width: 700px;
        }
        .alert{
            width:500px;
            height: 300px;
        }
        table {
            border-collapse : collapse;
        }        
        th{
            border : 1px solid gray;
            background-color: white;
            width: 250px;
        }
        td{
            border : 1px solid gray;
            background-color: white;
        }
        #thFinish{
            width:100px;
            border :0px;
            background-color: #D1E7DD;
        }
        #thDate{
            width : 180px;
        }
        #thTime{
            width : 130px;
        }
        #thDelete{
            width:100px;
            border :0px;
            background-color: #F8D7DA;
        }
        #later{
            color : red
        }

    </style>
    <script>
        //=========================================================================
        function gid(id) {return document.getElementById(id);}
        //=========================================================================
        //열을 추가하는 함수
        function appendRow(newword, date, time) {

            //tbodyToDo를 이용하여 새 행을 생성한다
            let tbodyToDo = gid("tbodyToDo")
            let newRow = tbodyToDo.insertRow(tbodyToDo.rows.length);
            //생성된 새 행(newRow)을 이용하여 내부에 두개의 행을 생성한다.
            let cell0 = newRow.insertCell(0);
            let cell1 = newRow.insertCell(1);
            let cell2 = newRow.insertCell(2);
            let cell3 = newRow.insertCell(3);
            let cell4 = newRow.insertCell(4);
            let cell5 = newRow.insertCell(5);

            //처음에 들어갈 체크박스를 만든다.
            let check = document.createElement("input");
            check.setAttribute("type", "checkbox");

            let inter = setInterval(overTime(date,time), 60000);
            //생성된 셀에 필요한 내용을 저장한다.
            cell0.appendChild(check);
            cell1.innerHTML =  overTime(date,time);
            cell2.innerHTML = "<strong>" + date + "</strong>";
            cell3.innerHTML = "<strong>" + time + "</strong>"; 
            cell4.innerHTML = "<Strong>" + newword + "</Strong>";
            cell5.innerHTML = "<Strong>" + "삭제" + "</Strong>";

            //생성된 셀에 필요한 이벤트 핸들러를 저장한다.
            $(check).click(btnFinishHandler);
            $(cell5).click(btnDeleteHandler);
        }
        //==========================================================================
        //--------------------------------------------------------------------------
        //엔터를 누르면 입력이 되는 함수
        function keydownHandler(){
            if(event.keyCode == 13){ //Enter key를 눌렀으면... 
                let date = gid("idate");
                let time = gid("itime");
                this.value = this.value.trim();
                if(this.value.length == 0) {    //스페이스바로 비워져있으면
                    return;
                }
                appendRow(this.value, date.value, time.value);  //안에 넣기
                this.value = "";        //엔터치고 비우기
            }
        } 
        //--------------------------------------------------------------------------
        //완료버튼을 누르면 입력이 되도록 하는 함수
        function finishHandler(){
            let newItem = gid("newItem");
            let date = gid("idate");
            let time = gid("itime");
            newItem.value = newItem.value.trim();
                if(newItem.value.length == 0) {    //스페이스바로 비워져있으면
                    return;
                }
                appendRow(newItem.value, date.value, time.value);  //안에 넣기
                newItem.value = "";        //엔터치고 비우기
        }
        //==========================================================================
        //--------------------------------------------------------------------------
        //click한 버튼을 포함하는 객체(버튼의 부모노드)를 삭제한다.
        function btnDeleteHandler(){
            $(this.parentNode).remove(); 
        }
        //--------------------------------------------------------------------------
        // 클릭한 span 객체를 listDone 객체의 자식노드로 보낸다.(연결한다)
        function btnFinishHandler(){
            let parentId = this.parentNode.parentNode.parentNode.getAttribute('id');
            
            if(parentId == "tbodyToDo"){
                gid("tbodyDone").appendChild(this.parentNode.parentNode);
            } else {
                gid("tbodyToDo").appendChild(this.parentNode.parentNode);
            } 
        }
        //==========================================================================
        //--------------------------------------------------------------------------
        //현재시간을 보여주기 위한 함수
        function setTime(){
                let divClock = gid("divClock");
                let ntime = new Date();

                let print = "";
                print += ntime.getFullYear() + "년 "
                print += ntime.getMonth() + 1 + "월 " 
                print += ntime.getDate() + "일 <br>"
                if(ntime.getHours()>12){      //시간이 12보다 크다면 오후 아니면 오전
                    print += "오후 ";
                    print += ntime.getHours()-12+"시 ";
                } else {
                    print += "오전 ";
                    print += ntime.getHours()+"시 ";
                }
                print += ntime.getMinutes()+"분 ";
                print += ntime.getSeconds()+"초";
                
                document.all.divClock.innerHTML = print
        }
        //-------------------------------------------------------------------------
        function overTime(date, time){
            let setDate = new Date(`${date}T${time}:00+0900`)
            let now = new Date();
             // D-day 날짜의 연,월,일 구하기
            let setDateYear = setDate.getFullYear();
            // getMonth 메서드는 0부터 세기 때문에 +1 해준다.
            let setDateMonth = setDate.getMonth() + 1;
            let setDateDay = setDate.getDate();

            let distance = setDate.getTime() - now.getTime();

            let day, hours, minuyes, title;

            if (distance > 0) {
                day = Math.floor(distance/(1000*60*60*24));
                hours = Math.floor((distance % (1000*60*60*24))/(1000*60*60));
                minutes = Math.floor((distance % (1000*60*60))/(1000*60));
                if(day == 0){
                    title = `${hours < 10 ? `0${hours}` : hours}시간${minutes < 10 ? `0${minutes}` : minutes}분`;
                }
                else {
                    title = `<strong> ${day}일 ${hours < 10 ? `0${hours}` : hours}시간${minutes < 10 ? `0${minutes}` : minutes}분 </strong>`;
                }
            }
            else  {
                distance = now.getTime() - setDate.getTime(); 
                day = Math.floor(distance/(1000*60*60*24));
                hours = Math.floor((distance % (1000*60*60*24))/(1000*60*60));
                minutes = Math.floor((distance % (1000*60*60))/(1000*60));
                
                title = `<strong id = 'later'>${day}일 ${hours < 10 ? `0${hours}` : hours}시간${minutes < 10 ? `0${minutes}` : minutes}분 </strong>`;
            }
                
            return title;
        }
        //=========================================================================
        //html문서가 준비되면 함수들 돌리는 곳
        $(document).ready(function(){
            setTime();                              //처음에 바로 시간이 보이도록
            tid=setInterval('setTime()', 1000);     //1초마다 시간이 계속 업데이트
            $("#newItem").keydown(keydownHandler);
            $("#btnFinish").click(finishHandler);    

            //처음 날짜 선택에 현재 날짜 들어가도록 
            gid('idate').value = new Date().toISOString().substring(0, 10);
        });
 
        //=========================================================================
    </script>
</head>
<body>
    <div id="divName">
        <h1>ToDo List Project</h1>
    </div>
    <div id = "divClock" class = "clock"> </div>
    <hr>
    기 간 : <input type="date" id = "idate"> <input type="time" id = "itime" value = "12:00">

    <br>
    해야할 일 : <input type="text" id="newItem" size="30">
    <button id = "btnFinish">완료</button>
    <hr>
    <h3>ToDo List</h3>
    <div class="alert alert-success" id="listToDo">
        <table>
            <thead>
                <th id = "thFinish"></th>
                <th>남은 시간</th>
                <th id ="thDate">날짜</th>
                <th id ="thTime">시간</th>
                <th>내용</th>
                <th id = "thFinish"></th>
            </thead>
            <tbody id = "tbodyToDo"></tbody>
        </table>
    </div>
    <h3>Done List</h3>
    <div class="alert alert-danger" id="listDone">
        <table> 
            <thead>
                <th id = "thDelete"></th>
                <th>남은 시간</th>
                <th id ="thDate">날짜</th>
                <th id ="thTime">시간</th>
                <th>내용</th>
                <th id = "thDelete"></th>
            </thead>
            <tbody id = "tbodyDone"></tbody>
        </table>
    </div>
</body>
</html>